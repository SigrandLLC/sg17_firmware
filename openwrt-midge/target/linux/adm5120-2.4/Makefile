include $(TOPDIR)/rules.mk

LINUX_VERSION:=2.4.32
LINUX_RELEASE:=1
LINUX_KERNEL_MD5SUM:=38f4d0830e95a20f4bfed17622d5557c

include ../rules.mk
include ./config

$(eval $(call KMOD_template,ADM5120_SW,adm5120-sw,\
	$(MODULES_DIR)/kernel/drivers/net/adm5120sw.o \
))
$(eval $(call KMOD_template,ADM5120_USB,usb-shci,\
	$(MODULES_DIR)/kernel/drivers/usb/host/usb-shci.o \
,CONFIG_USB_AHCI,kmod-usb-shci,55,usb-shci))

$(eval $(call KMOD_template,ADM5120_I2C,adm5120-i2c,\
	$(MODULES_DIR)/kernel/drivers/i2c/i2c-core.o \
	$(MODULES_DIR)/kernel/drivers/i2c/i2c-algo-bit.o \
	$(MODULES_DIR)/kernel/drivers/i2c/i2c-adm5120.o \
	$(MODULES_DIR)/kernel/drivers/i2c/i2c-dev.o \
	$(MODULES_DIR)/kernel/drivers/i2c/i2c-proc.o \
,CONFIG_I2C,,96,i2c-core i2c-algo-bit i2c-adm5120 i2c-dev))

include ../generic-$(KERNEL)/modules.mk
include ../kernel.mk

$(LINUX_DIR)/.patched: $(LINUX_DIR)/.unpacked
	[ -d ../generic-$(KERNEL)/patches ] && $(PATCH) $(LINUX_DIR) ../generic-$(KERNEL)/patches $(MAKE_TRACE)
	[ -d ./patches ] && $(PATCH) $(LINUX_DIR) ./patches $(MAKE_TRACE)
	@cp config $(LINUX_DIR)/.config
	touch $@


$(LINUX_DIR)/.unpacked: 
$(LINUX_DIR)/.depend_done: $(LINUX_DIR)/include/asm/am5120/mx_parts.h
$(LINUX_DIR)/.modules_done: $(LINUX_DIR)/include/asm/am5120/mx_parts.h
$(STAMP_DIR)/.linux-compile: $(LINUX_DIR)/include/asm/am5120/mx_parts.h $(LINUX_DIR)/.modules_done

$(LINUX_DIR)/include/asm/am5120/mx_parts.h: 
	( \
		echo '/**********************************************************************************'> $@; \
		echo ';   Auto generated by target/linux/adm5120-2.4/Makefile' >>$@; \
		echo ';   DO NOT EDIT!!!' >>$@; \
		echo ';**********************************************************************************/'>> $@; \
		echo '#define FLASH_SIZE      $(MIDGE_FLASH_SIZE)' >>$@; \
		echo '#define FLASH_PART_BOOT_ADDR    0x00000000' >>$@; \
		echo '#define FLASH_PART_BOOT_SIZE    $(MIDGE_BOOT_SIZE)' >>$@; \
		echo '#define FLASH_PART_KERNEL_ADDR  $(MIDGE_KERNEL_START)' >>$@; \
		echo '#define FLASH_PART_KERNEL_SIZE  $(shell printf '0x%04X0000' $(MIDGE_KERNEL_BLOCKS))' >>$@; \
		echo '#define FLASH_PART_ROOT_SIZE    $(shell printf '0x%04X0000' $(MIDGE_SQUASHFS_BLOCKS))' >>$@; \
	)

#$(LINUX_BUILD_DIR)/vmlinuz: $(LINUX_DIR)/vmlinux
#	cp  $(LINUX_DIR)/vmlinuz $@
#	touch $@
#
#compile: $(LINUX_BUILD_DIR)/vmlinuz
